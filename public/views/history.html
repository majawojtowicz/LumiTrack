<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles/main.css">
    <link rel="stylesheet" href="public/styles/dashboard.css">
    <link rel="stylesheet" href="public/styles/history.css">
    <link rel="stylesheet" href="public/styles/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>LumiTrack ‚Äì History</title>
</head>
<body>

<nav class="topbar">
    <div class="logo">
        <div class="logo-icon">L</div>
        <span>LumiTrack</span>
    </div>
    <ul class="nav-links">
    <li><a href="/dashboard"><i class="fa-solid fa-house"></i> Dashboard</a></li>
        <li class="active"><a href="/history"><i class="fa-solid fa-clock-rotate-left"></i> History</a></li>
        <li><a href="/statistics"><i class="fa-solid fa-chart-line"></i> Statistics</a></li>
        <li><a href="/profile"><i class="fa-solid fa-user"></i> Profile</a></li>
    </li>
    <?php if (($user['role'] ?? '') === 'ADMIN'): ?>
    <li class="<?= $page === 'admin' ? 'active' : '' ?>"><a href="/admin"><i class="fa-solid fa-shield-halved"></i> Admin</a></li>
    <?php endif; ?>
</ul>
</nav>

<div class="container">
    <aside></aside> 
    <main class="dashboard"> 
        <div class="dashboard-container">
            <header class="welcome">
                <h1>Your History üìÖ</h1>
                <p>Review your past energy levels and reflections.</p>
            </header>

            <div class="filter-section-container" style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <div class="filter-container" style="margin-bottom: 15px;">
                    <input type="text" id="historySearch" placeholder="üîç Search in notes, dates or #tags..." class="search-input" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd;">
                </div>
                
                <div class="mood-filters" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="filter-btn active" data-mood="all">All</button>
                    <button class="filter-btn" data-mood="1">üòû Sad</button>
                    <button class="filter-btn" data-mood="2">üòê Neutral</button>
                    <button class="filter-btn" data-mood="3">üòä Happy</button>
                </div>
            </div>

            <div class="history-list" id="entriesContainer">
                <?php if (empty($entries)): ?>
                    <section class="card empty-state">
                        <p>No entries yet. How about adding one today?</p>
                        <a href="/dashboard" class="save-btn" style="text-decoration:none; text-align:center; display:inline-block; width: auto; padding: 10px 20px;">Go to Dashboard</a>
                    </section>
                <?php else: ?>
                    <?php foreach ($entries as $entry): ?>
                        <section class="card entry-card" id="entry-<?= $entry['id'] ?>" data-mood="<?= $entry['mood'] ?>">
                            <div class="entry-header">
                                <div>
                                    <span class="date" style="font-weight: bold;"><?= date('l, d M Y', strtotime($entry['created_at'])) ?></span>
                                    <span class="time" style="color: #666; margin-left: 10px;"><?= date('H:i', strtotime($entry['created_at'])) ?></span>
                                </div>
                                <button onclick="deleteEntry(<?= $entry['id'] ?>)" class="remove-btn" style="background: #fee2e2; color: #ef4444; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer;">Remove</button>
                            </div>

                            <?php if (!empty($entry['tags_list'])): ?>
                                <div class="entry-tags" style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    <?php 
                                        $tags = explode(', ', $entry['tags_list']); 
                                        foreach($tags as $tag): 
                                    ?>
                                        <span class="tag-item" style="background: #eef2ff; color: #6366f1; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                                            #<?= htmlspecialchars($tag) ?>
                                        </span>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>

                            <div class="stats-row" style="display: flex; gap: 20px; margin-top: 15px; padding: 15px 0; border-top: 1px solid #eee;">
                                <div class="stat">
                                    <span class="label" style="display: block; font-size: 0.8rem; color: #666;">‚ö° Energy</span>
                                    <div class="bar-bg" style="width: 100px; height: 8px; background: #eee; border-radius: 4px; margin-top: 5px;">
                                        <div class="bar-fill" style="width: <?= ($entry['energy']/5)*100 ?>%; height: 100%; background: #4f46e5; border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div class="stat">
                                    <span class="label" style="display: block; font-size: 0.8rem; color: #666;">üòä Mood</span>
                                    <span class="val" style="font-weight: 600;"><?= $entry['mood'] == 1 ? 'Sad' : ($entry['mood'] == 2 ? 'Neutral' : 'Happy') ?></span>
                                </div>
                                <div class="stat">
                                    <span class="label" style="display: block; font-size: 0.8rem; color: #666;">üéØ Focus</span>
                                    <span class="val" style="font-weight: 600;"><?= $entry['focus'] == 1 ? 'Low' : ($entry['focus'] == 2 ? 'Normal' : 'Deep') ?></span>
                                </div>
                            </div>

                            <?php if (!empty($entry['note'])): ?>
                                <div class="note-box" style="background: #f9fafb; padding: 12px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #ddd;">
                                    <p class="note-content" style="margin: 0; font-size: 0.95rem; color: #374151;"><?= htmlspecialchars($entry['note']) ?></p>
                                </div>
                            <?php endif; ?>
                        </section>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('historySearch');
    const moodButtons = document.querySelectorAll('.filter-btn');
    
    let activeMood = 'all';

    function filterEntries() {
        const searchText = searchInput.value.toLowerCase();
        const cards = document.querySelectorAll('.entry-card');

        cards.forEach(card => {
            const cardMood = card.getAttribute('data-mood');
            const noteContent = card.querySelector('.note-content')?.innerText.toLowerCase() || '';
            const dateContent = card.querySelector('.date').innerText.toLowerCase();
            const tagsContent = card.querySelector('.entry-tags')?.innerText.toLowerCase() || '';

            const matchesMood = (activeMood === 'all' || cardMood === activeMood);
            const matchesSearch = noteContent.includes(searchText) || 
                                dateContent.includes(searchText) || 
                                tagsContent.includes(searchText);

            if (matchesMood && matchesSearch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    moodButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            moodButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeMood = btn.getAttribute('data-mood');
            filterEntries();
        });
    });

    searchInput.addEventListener('input', filterEntries);
});

async function deleteEntry(id) {
    if (!confirm('Are you sure you want to remove this entry?')) return;

    try {
        const response = await fetch(`/delete-entry?id=${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            const card = document.getElementById(`entry-${id}`);
            if (card) {
                card.style.transition = 'all 0.4s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                    card.remove();
                    if (document.querySelectorAll('.entry-card').length === 0) {
                        location.reload();
                    }
                }, 400);
            }
        } else {
            alert('Something went wrong while deleting.');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>

</body>
</html>