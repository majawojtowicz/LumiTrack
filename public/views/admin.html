<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles/main.css">
    <link rel="stylesheet" href="public/styles/dashboard.css">
    <link rel="stylesheet" href="public/styles/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>LumiTrack – Panel Admina</title>
</head>
<body>

<nav class="topbar">
    <div class="logo">
        <div class="logo-icon">L</div>
        <span>LumiTrack</span>
    </div>
    <ul class="nav-links">
        <li><a href="/dashboard"><i class="fa-solid fa-house"></i> Dashboard</a></li>
        <li><a href="/history"><i class="fa-solid fa-clock-rotate-left"></i> History</a></li>
        <li><a href="/statistics"><i class="fa-solid fa-chart-line"></i> Statistics</a></li>
        <li><a href="/profile"><i class="fa-solid fa-user"></i> Profile</a></li>
        <li class="active"><a href="/admin"><i class="fa-solid fa-shield-halved"></i> Admin</a></li>
    </ul>
</nav>

<div class="container">
    <main class="admin-container">
        <header class="welcome" style="text-align: center; margin-bottom: 40px;">
            <h1>Panel Administrator</h1>
            <p>Monitor system - LumiTrack</p>
        </header>

        <?php
            $totalUsers = is_array($users) ? count($users) : 0;
            $adminCount = 0;
            $blockedCount = 0;
            if ($totalUsers > 0) {
                foreach($users as $u) {
                    if (($u['role'] ?? '') === 'ADMIN') $adminCount++;
                    if (isset($u['is_blocked']) && $u['is_blocked']) $blockedCount++;
                }
            }
            $activeCount = $totalUsers - $blockedCount;
        ?>

        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon bg-blue"><i class="fa-solid fa-users"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Total Users</span>
                    <span class="stat-value"><?= $totalUsers ?></span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-green"><i class="fa-solid fa-user-check"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Active Users</span>
                    <span class="stat-value"><?= $activeCount ?></span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-red"><i class="fa-solid fa-user-slash"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Blocked Users</span>
                    <span class="stat-value" id="blocked-count-val"><?= $blockedCount ?></span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-purple"><i class="fa-solid fa-shield-halved"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Total Admins</span>
                    <span class="stat-value"><?= $adminCount ?></span>
                </div>
            </div>
        </section>

        <section class="user-management">
            <h3 style="margin-bottom: 5px;"><i class="fa-solid fa-users-gear"></i> User Management</h3>
            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 20px;">Manage users</p>

            <div class="user-list">
                <?php if (isset($users) && is_array($users)): ?>
                    <?php foreach ($users as $u): ?>
                    <div class="user-list-item" id="user-row-<?= $u['id'] ?>">
                        <div class="user-info-wrapper">
                            <div class="user-avatar"><?= strtoupper(substr($u['firstname'] ?? 'U', 0, 1)) ?></div>
                            <div class="user-details">
                                <span class="user-email"><?= htmlspecialchars($u['email']) ?></span>
                                <span class="user-joined">Imię: <?= htmlspecialchars($u['firstname'] ?? 'User') ?></span>
                            </div>
                        </div>
                        <div class="user-actions">
                            <?php if (($u['role'] ?? '') === 'ADMIN'): ?>
                                <span class="badge badge-admin"><i class="fa-solid fa-shield"></i> Admin</span>
                            <?php endif; ?>
                            
                            <span id="status-badge-<?= $u['id'] ?>" class="badge <?= $u['is_blocked'] ? 'badge-blocked' : 'badge-active' ?>">
                                <?= $u['is_blocked'] ? 'Blocked' : 'Active' ?>
                            </span>
                            
                            <?php if (isset($user) && $u['id'] != $user['id']): ?>
                                <button id="block-btn-<?= $u['id'] ?>" class="btn-block" onclick="toggleBlock(<?= $u['id'] ?>)">
                                    <?= $u['is_blocked'] ? 'Unblock' : 'Block' ?>
                                </button>
                            <?php else: ?>
                                <span style="font-size: 0.75rem; color: #94a3b8; margin-left: 10px;">(Ty)</span>
                            <?php endif; ?>
                        </div>
                    </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p style="text-align: center; padding: 20px;">No users</p>
                <?php endif; ?>
            </div>
        </section>

        <section class="user-management" style="margin-top: 40px;">
            <h3><i class="fa-solid fa-list-ul"></i> System Activity Log</h3>
            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 20px;">Last entries of users</p>
            <div class="user-list">
                <?php if(isset($logs) && is_array($logs) && count($logs) > 0): ?>
                    <?php foreach ($logs as $log): ?>
                        <div class="user-list-item">
                            <div class="user-info-wrapper">
                                <div class="user-details">
                                    <span class="user-email"><?= htmlspecialchars($log['firstname'] . ' ' . $log['lastname'] ) ?></span>
                                    <span class="user-joined">
                                        Mood: <strong><?= $log['mood'] ?></strong> | 
                                        Energia: <strong><?= $log['energy'] ?></strong>
                                    </span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <span class="user-joined"><?= date('H:i d.m.Y', strtotime($log['created_at'])) ?></span>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p style="text-align: center; padding: 20px; color: #94a3b8;">No activieties</p>
                <?php endif; ?>
            </div>
        </section>

        <section class="system-info-card">
            <h4>System Information</h4>
            <div class="system-row">
                <span>Nr of Admins:</span>
                <span><?= $adminCount ?></span>
            </div>
            <div class="system-row">
                <span>Nr of Users:</span>
                <span><?= $totalUsers - $adminCount ?></span>
            </div>
            <div class="system-row">
                <span>Status System:</span>
                <span style="color: #16a34a; font-weight: bold;">Operating</span>
            </div>
        </section>
    </main>
</div>

<script>
async function toggleBlock(id) {
    try {
        const response = await fetch(`/admin-toggle-block?id=${id}`);
        const result = await response.json();

        if (response.ok && result.success) {
            const btn = document.getElementById(`block-btn-${id}`);
            const badge = document.getElementById(`status-badge-${id}`);
            const blockedCounter = document.getElementById('blocked-count-val');
            
            let currentBlocked = parseInt(blockedCounter.textContent);

            if (result.is_blocked) {
                btn.textContent = 'Unblock';
                badge.textContent = 'Blocked';
                badge.className = 'badge badge-blocked';
                blockedCounter.textContent = currentBlocked + 1;
            } else {
                btn.textContent = 'Block';
                badge.textContent = 'Active';
                badge.className = 'badge badge-active';
                blockedCounter.textContent = Math.max(0, currentBlocked - 1);
            }
        } else {
            alert('Wystąpił błąd podczas zmiany statusu.');
        }
    } catch (e) {
        console.error('Błąd:', e);
    }
}
</script>

</body>
</html>